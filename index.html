<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus AI - Enterprise Assistant</title>
    <meta name="description" content="Advanced AI Chatbot Interface">
    
    <style>
        /* 
         * NEXUS AI MINI-FRAMEWORK v1.0 
         * Enterprise Grade CSS Architecture 
         */

        :root {
            /* Color Palette - Indigo Theme */
            --primary-50: #eef2ff;
            --primary-100: #e0e7ff;
            --primary-200: #c7d2fe;
            --primary-300: #a5b4fc;
            --primary-400: #818cf8;
            --primary-500: #6366f1;
            --primary-600: #4f46e5;
            --primary-700: #4338ca;
            --primary-800: #3730a3;
            --primary-900: #312e81;
            
            /* Semantic Colors */
            --bg-body: #f8fafc;
            --bg-glass: rgba(255, 255, 255, 0.75);
            --bg-glass-dark: rgba(15, 23, 42, 0.85);
            --bg-sidebar: rgba(241, 245, 249, 0.95);
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-light: rgba(226, 232, 240, 0.8);
            --border-glass: rgba(255, 255, 255, 0.5);
            
            /* Message Colors */
            --msg-user-bg: linear-gradient(135deg, #4f46e5, #6366f1);
            --msg-user-text: #ffffff;
            --msg-bot-bg: #ffffff;
            --msg-bot-text: #334155;
            --msg-bot-border: #e2e8f0;

            /* Shadows & Effects */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --backdrop-blur: blur(16px);
            --transition-base: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Dimensions */
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --bg-body: #020617;
            --bg-glass: rgba(30, 41, 59, 0.7);
            --bg-glass-dark: rgba(2, 6, 23, 0.95);
            --bg-sidebar: rgba(15, 23, 42, 0.95);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-light: rgba(51, 65, 85, 0.6);
            --border-glass: rgba(255, 255, 255, 0.1);
            --msg-bot-bg: #1e293b;
            --msg-bot-text: #e2e8f0;
            --msg-bot-border: #334155;
        }

        /* Reset & Base */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        html { scroll-behavior: smooth; font-size: 16px; -webkit-font-smoothing: antialiased; }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            /* High-tech abstract background */
            background-image: 
                radial-gradient(at 0% 0%, rgba(79, 70, 229, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
                url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .cursor-pointer { cursor: pointer; }
        .opacity-50 { opacity: 0.5; }
        .transition { transition: var(--transition-base); }

        /* Icons */
        svg { width: 20px; height: 20px; stroke-width: 2; }
        
        /* --- Floating Launch Button --- */
        .launcher-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--primary-600);
            color: white;
            border: none;
            box-shadow: var(--shadow-xl);
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
            animation: pulse-ring 2s infinite;
        }

        .launcher-btn:hover { transform: scale(1.1) rotate(5deg); }
        .launcher-btn svg { width: 32px; height: 32px; fill: none; stroke: white; stroke-linecap: round; stroke-linejoin: round; }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }

        /* --- Main Widget Container --- */
        .widget-container {
            position: fixed;
            bottom: 7rem;
            right: 2rem;
            width: 900px;
            height: 650px;
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-2xl);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            pointer-events: none;
            transition: var(--transition-base);
            z-index: 9998;
        }

        .widget-container.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-circle {
            width: 36px;
            height: 36px;
            background: var(--primary-600);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .history-item {
            padding: 0.75rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            margin-bottom: 0.25rem;
            color: var(--text-muted);
            transition: var(--transition-base);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item:hover { background: var(--primary-50); color: var(--primary-700); }
        .history-item.active { background: var(--primary-100); color: var(--primary-800); font-weight: 600; }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-light);
        }

        /* --- Chat Area --- */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255,255,255,0.4);
        }

        .chat-header {
            height: 70px;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.2);
        }

        .agent-info { display: flex; align-items: center; gap: 0.75rem; }
        .agent-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            overflow: hidden;
        }
        .agent-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .status-dot {
            width: 8px; height: 8px;
            background: #22c55e;
            border-radius: 50%;
            border: 2px solid white;
            display: inline-block;
            margin-right: 4px;
        }

        .header-actions button {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 0.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-base);
        }
        .header-actions button:hover { background: var(--primary-50); color: var(--primary-600); }

        /* --- Messages Feed --- */
        .messages-feed {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
        }

        .messages-feed::-webkit-scrollbar { width: 6px; }
        .messages-feed::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .messages-feed::-webkit-scrollbar-track { background: transparent; }

        /* Message Groups */
        .msg-row { display: flex; gap: 1rem; max-width: 85%; animation: fadeUp 0.3s ease-out; }
        .msg-row.user { align-self: flex-end; flex-direction: row-reverse; }
        
        .msg-bubble {
            padding: 1rem;
            border-radius: var(--radius-xl);
            position: relative;
            line-height: 1.5;
            font-size: 0.95rem;
            box-shadow: var(--shadow-sm);
        }

        .msg-row.bot .msg-bubble {
            background: var(--msg-bot-bg);
            color: var(--msg-bot-text);
            border: 1px solid var(--msg-bot-border);
            border-top-left-radius: 4px;
        }

        .msg-row.user .msg-bubble {
            background: var(--msg-user-bg);
            color: var(--msg-user-text);
            border-top-right-radius: 4px;
            box-shadow: var(--shadow-md);
        }

        .msg-time {
            font-size: 0.7rem;
            margin-top: 0.25rem;
            opacity: 0.7;
            text-align: right;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Typing Indicator --- */
        .typing-wrapper {
            display: flex; gap: 0.5rem; padding: 1rem; 
            background: var(--msg-bot-bg);
            border-radius: var(--radius-xl);
            border-top-left-radius: 4px;
            border: 1px solid var(--msg-bot-border);
            width: fit-content;
            margin-bottom: 1rem;
            animation: fadeUp 0.3s ease-out;
        }
        .typing-dot {
            width: 8px; height: 8px; background: #94a3b8; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- Input Area --- */
        .input-container {
            padding: 1.5rem;
            background: rgba(255,255,255,0.5);
            border-top: 1px solid var(--border-light);
        }

        .input-box-wrapper {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: 0.75rem;
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-base);
        }

        .input-box-wrapper:focus-within {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 24px;
            padding: 0.25rem;
            font-family: inherit;
            color: var(--text-main);
            background: transparent;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background: var(--primary-50); color: var(--primary-600); }
        
        .send-btn {
            background: var(--primary-600);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: var(--transition-base);
        }
        .send-btn:hover { background: var(--primary-700); transform: scale(1.05); }

        /* --- Modals & Overlays --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        
        .modal-content {
            background: white; width: 400px; padding: 2rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-2xl);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.open .modal-content { transform: scale(1); }

        /* --- Toast Notifications --- */
        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 10001;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: white; padding: 1rem; border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg); border-left: 4px solid var(--primary-600);
            min-width: 250px; animation: slideInRight 0.3s ease-out;
            display: flex; align-items: center; justify-content: space-between;
        }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .widget-container {
                width: 100%; height: 100%; bottom: 0; right: 0;
                border-radius: 0;
            }
            .sidebar { position: absolute; left: -100%; height: 100%; z-index: 10; background: var(--bg-glass); }
            .sidebar.mobile-open { transform: translateX(100%); left: -260px; }
            .launcher-btn { bottom: 1.5rem; right: 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- Floating Launcher -->
    <button class="launcher-btn" id="launcherBtn" aria-label="Open Chat">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </button>

    <!-- Main Widget -->
    <div class="widget-container" id="widget">
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-circle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                </div>
                <div>
                    <h3 class="font-bold text-sm">Nexus AI</h3>
                    <p class="text-xs text-muted">Enterprise Support</p>
                </div>
            </div>
            
            <div class="history-list" id="historyList">
                <!-- History items injected by JS -->
                <div class="history-item active">
                    <div class="font-bold text-sm">Current Session</div>
                    <div class="text-xs">Just now</div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="icon-btn w-full justify-center gap-2" id="newChatBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>New Chat</span>
                </button>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area">
            <!-- Header -->
            <header class="chat-header">
                <div class="flex items-center gap-2">
                    <button class="icon-btn md:hidden" id="mobileMenuBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <div class="agent-info">
                        <div class="agent-avatar">
                            <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="Bot">
                        </div>
                        <div>
                            <h3 class="font-bold text-sm">Sarah (AI)</h3>
                            <p class="text-xs flex items-center text-muted"><span class="status-dot"></span>Online</p>
                        </div>
                    </div>
                </div>

                <div class="header-actions flex gap-2">
                    <button id="themeBtn" title="Toggle Theme">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <button id="settingsBtn" title="Settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    <button id="closeBtn" title="Close">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </header>

            <!-- Messages -->
            <div class="messages-feed" id="messagesFeed">
                <div class="msg-row bot">
                    <div class="agent-avatar" style="width:32px; height:32px; flex-shrink:0;">
                        <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="Bot">
                    </div>
                    <div class="msg-bubble">
                        Hello! I am Nexus, your AI assistant. How can I help you optimize your workflow today?
                        <div class="msg-time">Just now</div>
                    </div>
                </div>
                <!-- Typing Indicator (Hidden by default) -->
                <div class="typing-wrapper hidden" id="typingIndicator">
                    <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                </div>
            </div>

            <!-- Input -->
            <div class="input-container">
                <div class="input-box-wrapper">
                    <button class="icon-btn" title="Upload File">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    </button>
                    <textarea class="chat-input" id="chatInput" rows="1" placeholder="Type your message..."></textarea>
                    <button class="icon-btn" id="voiceBtn" title="Voice Input">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <button class="send-btn" id="sendBtn" aria-label="Send Message">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <p class="text-xs text-muted">Powered by Nexus AI Engine v2.0</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <h2 class="font-bold text-lg mb-4">Settings</h2>
            <div class="flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <span>Sound Notifications</span>
                    <input type="checkbox" id="soundToggle" checked>
                </div>
                <div class="flex justify-between items-center">
                    <span>Auto-Scroll</span>
                    <input type="checkbox" id="scrollToggle" checked>
                </div>
                <div class="flex justify-between items-center">
                    <span>Data Persistence</span>
                    <input type="checkbox" id="persistenceToggle" checked>
                </div>
                <hr class="border-light">
                <button class="w-full py-2 rounded-lg bg-primary-600 text-white font-bold" id="clearHistoryBtn">Clear Chat History</button>
            </div>
            <button class="absolute top-4 right-4 text-muted" id="closeSettings"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        /**
         * NEXUS AI CLIENT ENGINE
         * Single File Architecture
         */

        // --- State Management ---
        const State = {
            isOpen: false,
            isTyping: false,
            theme: localStorage.getItem('theme') || 'light',
            messages: [],
            settings: {
                sound: true,
                autoScroll: true,
                persistence: true
            }
        };

        // --- Audio Controller ---
        const AudioCtrl = {
            ctx: null,
            init() {
                if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playTone(type) {
                if (!State.settings.sound) return;
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                if (type === 'send') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, this.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(300, this.ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 0.1);
                } else if (type === 'receive') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(600, this.ctx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                    gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.3);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 0.3);
                }
            }
        };

        // --- DOM Elements ---
        const UI = {
            widget: document.getElementById('widget'),
            launcher: document.getElementById('launcherBtn'),
            closeBtn: document.getElementById('closeBtn'),
            messages: document.getElementById('messagesFeed'),
            input: document.getElementById('chatInput'),
            sendBtn: document.getElementById('sendBtn'),
            typing: document.getElementById('typingIndicator'),
            themeBtn: document.getElementById('themeBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettings: document.getElementById('closeSettings'),
            toastContainer: document.getElementById('toastContainer'),
            sidebar: document.getElementById('sidebar'),
            mobileMenu: document.getElementById('mobileMenuBtn')
        };

        // --- Core Functions ---

        function toggleChat() {
            State.isOpen = !State.isOpen;
            if (State.isOpen) {
                UI.widget.classList.add('active');
                UI.launcher.classList.add('hidden');
                UI.input.focus();
                loadHistory();
            } else {
                UI.widget.classList.remove('active');
                UI.launcher.classList.remove('hidden');
            }
        }

        function toggleTheme() {
            State.theme = State.theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', State.theme);
            localStorage.setItem('theme', State.theme);
        }

        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }

        function scrollToBottom() {
            if (State.settings.autoScroll) {
                UI.messages.scrollTop = UI.messages.scrollHeight;
            }
        }

        function createMessageElement(text, sender) {
            const row = document.createElement('div');
            row.className = `msg-row ${sender}`;
            
            let avatarHtml = '';
            if (sender === 'bot') {
                avatarHtml = `
                <div class="agent-avatar" style="width:32px; height:32px; flex-shrink:0;">
                    <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixlib=rb-1.2.1&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80" alt="Bot">
                </div>`;
            }

            row.innerHTML = `
                ${avatarHtml}
                <div class="msg-bubble">
                    ${text}
                    <div class="msg-time">${getCurrentTime()}</div>
                </div>
            `;
            return row;
        }

        function appendMessage(text, sender, save = true) {
            const msgEl = createMessageElement(text, sender);
            // Insert before typing indicator
            UI.messages.insertBefore(msgEl, UI.typing);
            scrollToBottom();
            
            if (save) {
                State.messages.push({ text, sender, time: Date.now() });
                if (State.settings.persistence) localStorage.setItem('chatHistory', JSON.stringify(State.messages));
            }
        }

        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span>${msg}</span> <span style="cursor:pointer" onclick="this.parentElement.remove()">âœ•</span>`;
            UI.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function handleSend() {
            const text = UI.input.value.trim();
            if (!text || State.isTyping) return;

            UI.input.value = '';
            UI.input.style.height = 'auto'; // Reset height
            AudioCtrl.playTone('send');
            appendMessage(text, 'user');

            // Show typing
            UI.typing.classList.remove('hidden');
            scrollToBottom();
            State.isTyping = true;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await response.json();
                
                UI.typing.classList.add('hidden');
                State.isTyping = false;

                if (data.response) {
                    AudioCtrl.playTone('receive');
                    appendMessage(data.response, 'bot');
                } else {
                    appendMessage("I apologize, but I couldn't process that request.", 'bot');
                }
            } catch (e) {
                console.error(e);
                UI.typing.classList.add('hidden');
                State.isTyping = false;
                appendMessage("Connection error. Please check your network.", 'bot');
                showToast("Server disconnected", "error");
            }
        }

        function loadHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (saved && State.messages.length === 0) {
                const history = JSON.parse(saved);
                history.forEach(msg => {
                    State.messages.push(msg);
                    const el = createMessageElement(msg.text, msg.sender);
                    UI.messages.insertBefore(el, UI.typing);
                });
                scrollToBottom();
            }
        }

        // --- Event Listeners ---

        UI.launcher.addEventListener('click', toggleChat);
        UI.closeBtn.addEventListener('click', toggleChat);
        UI.themeBtn.addEventListener('click', toggleTheme);
        
        UI.sendBtn.addEventListener('click', handleSend);
        
        UI.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        // Auto-expand textarea
        UI.input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Settings Modal
        UI.settingsBtn.addEventListener('click', () => UI.settingsModal.classList.add('open'));
        UI.closeSettings.addEventListener('click', () => UI.settingsModal.classList.remove('open'));
        
        // Toggles
        document.getElementById('soundToggle').addEventListener('change', (e) => State.settings.sound = e.target.checked);
        document.getElementById('scrollToggle').addEventListener('change', (e) => State.settings.autoScroll = e.target.checked);
        
        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            localStorage.removeItem('chatHistory');
            State.messages = [];
            // Remove all msg-rows except welcome
            const rows = document.querySelectorAll('.msg-row');
            rows.forEach((row, index) => {
                if (index > 0) row.remove(); // Keep first welcome msg
            });
            UI.settingsModal.classList.remove('open');
            showToast("History cleared");
        });

        // Mobile Sidebar
        UI.mobileMenu.addEventListener('click', () => {
            UI.sidebar.classList.toggle('mobile-open');
        });

        // Initialize
        document.documentElement.setAttribute('data-theme', State.theme);

    </script>
</body>
</html>